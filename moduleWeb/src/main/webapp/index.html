<!DOCTYPE html>
<html>
<head>
	<title>Task manager</title>
        <meta charset="utf-8">
        <style type="text/css">
table.table {
    border-collapse: collapse;
    margin: 5px 0 5px 2px;
    width: auto;
}
table {
    display: table;
    border-collapse: separate;
    border-spacing: 2px;
    border-color: grey;
}
th.th {
    border: 2px solid #ccc;
    background: #f5f5f5;
    padding: 0px 10px 0px 10px;
    text-align: center;
}
td.td {
    border: 2px solid #ccc;
    padding: 0px 10px 0px 10px;
}
th {
    font-weight: bold;
}
td, th {
    display: table-cell;
    vertical-align: inherit;
}
        </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script type="text/javascript">
		
		function findById(source, id) {
			  for (var i = 0; i < source.length; i++) {
			    if (source[i].id === id) {
			      return source[i];
			    }
			  }
			  throw "Couldn't find object with id: " + id;
			}
		
	$(document).ready(function(){
			viewRequest("view", 1);
			})
			
			
	function deleteRequest(reqURL, id)
	{
		//Creating a new XMLHttpRequest object
		var xmlhttp;
		if (window.XMLHttpRequest){
			xmlhttp = new XMLHttpRequest(); //for IE7+, Firefox, Chrome, Opera, Safari
		} else {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); //for IE6, IE5
		}
		var params = 'id=' + encodeURIComponent(id);
		//Create a asynchronous GET request
		xmlhttp.open("POST", reqURL, false);
		xmlhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
		xmlhttp.send(params);
	}
		
	function viewRequest(reqURL, page)
	{
		//Creating a new XMLHttpRequest object
		var xmlhttp;
		if (window.XMLHttpRequest){
			xmlhttp = new XMLHttpRequest(); //for IE7+, Firefox, Chrome, Opera, Safari
		} else {
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); //for IE6, IE5
		}
		var params = 'page=' + encodeURIComponent(page);
		//Create a asynchronous GET request
		xmlhttp.open("POST", reqURL, false);
		xmlhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
		xmlhttp.send(params);
		
		//Execution blocked till server send the response
		if (xmlhttp.readyState == 4) { 
			if (xmlhttp.status == 200) 
			{
				//document.getElementById("message").innerHTML = xmlhttp.responseText;
				var obj = jQuery.parseJSON( xmlhttp.responseText);
				
				//Данные
				var TableTitle = ["Task", "Priority", "Delete"];
				//Создадим структуру
				var mytable = $('<table/>',{
									class:'table'
								}).append(
									$('<thead/>'),
									$('<tfoot/>'),
									$('<tbody/>')
								);
				
				
				
				//Наполняем табличку
				//Заголовок
				var TitleCell = $('<tr/>');
				$.each(TableTitle,function( myIndex, myData ) {
					TitleCell.append(
						$('<th/>',{
							class:'th',
							text:myData
						})
					);
				});
				$("thead",mytable).append(TitleCell);
				
				//Данные
				$.each(obj.tasks,function() {
					//Переопределяем строку
					var DataCell = $('<tr/>');

						DataCell.append(
								$('<td/>',{
									class:'td',
									text:this.name
								})
							);
						var pr1 = obj.priorities.find(function (d) {return d.id === this.priorityId;} );
						var result = jQuery.find(obj.priorities, function(e){ return e.id == this.priorityId; });
						var pr2 = findById(obj.priorities, this.priorityId).name;
						DataCell.append(
								$('<td/>',{
									class:'td',
									text:pr2
								})
							);
							DataCell.append(
									$('<td/>',{
										class:'td'
									}).append($('<a/>',{ href:'#', text:'Delete', onclick:'deleteRequest("delete", ' + this.id + ');viewRequest("view", 1);'}))
								);
							

					$("tbody",mytable).append(DataCell);
				});
				
				$('#message').empty();
				$('#message').append(mytable);		
			
				//alert(xmlhttp.responseText);
			} 
			else
			{
				alert('Something is wrong !!');
			}
		}
	}
	
	</script>
</head>
<body>
	<br/>
	<span id="message"></span>
	
	
</body>
</html>
